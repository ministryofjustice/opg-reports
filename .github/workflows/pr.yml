name: "[PR] Workflow"

on:
  pull_request:
    branches: [main]

jobs:
  setup:
    name: "Setup"
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch_name.outputs.branch_name }}
      terraform_workspace: ${{ steps.terraform_workspace.outputs.trimmed }}
      terraform_version_account: ${{ steps.terraform_account_version.outputs.version }}
      terraform_version_environment: ${{ steps.terraform_environment_version.outputs.version }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
      - name: "Get branch name"
        id: branch_name
        uses: ministryofjustice/opg-github-actions/.github/actions/branch-name@v3.0.6
      - id: terraform_workspace
        name: "Get terraform workspace name"
        uses: ministryofjustice/opg-github-actions/.github/actions/safe-strings@v3.0.6
        with:
          original: ${{ steps.branch.outputs.branch_name }}
          conditional_match: "main"
          conditional_value: "production"
          suffix: ${{ github.event.number }}
          length: 12
      - name: "Parse terraform account version"
        id: terraform_account_version
        uses: ministryofjustice/opg-github-actions/.github/actions/terraform-version@v3.0.6
        with:
          terraform_directory: ./terraform/account
      - name: "Parse terraform environment version"
        id: terraform_environment_version
        uses: ministryofjustice/opg-github-actions/.github/actions/terraform-version@v3.0.6
        with:
          terraform_directory: ./terraform/environment

  # run all tests
  go_tests:
    needs: [setup]
    name: "[Go] Tests"
    uses: './.github/workflows/_tests.yml'
    secrets: inherit

  # run account level terraform
  terraform_account:
    needs: [setup]
    name: "[Terraform] Account"
    uses: './.github/workflows/_terraform.yml'
    with:
      apply: ${{ github.ref == 'refs/heads/main' }}
      directory: ./terraform/account
      workspace: ${{ needs.setup.outputs.terraform_workspace }}
      version: ${{ needs.setup.outputs.terraform_version_account }}
      register_ephemeral: ${{ github.ref != 'refs/heads/main' }}
    secrets: inherit

  # run env level terraform
  terraform_environment:
    needs: [setup]
    name: "[Terraform] Environment"
    uses: './.github/workflows/_terraform.yml'
    with:
      apply: ${{ github.ref == 'refs/heads/main' }}
      directory: ./terraform/environment
      workspace: ${{ needs.setup.outputs.terraform_workspace }}
      version: ${{ needs.setup.outputs.terraform_version_environment }}
      register_ephemeral: ${{ github.ref != 'refs/heads/main' }}
    secrets: inherit



  # helper to output summary of steps
  summary:
    if: always()
    needs: [setup]
    runs-on: ubuntu-latest
    steps:
      - name: "Summary"
        run: |
          echo "### Setup" >> $GITHUB_STEP_SUMMARY
          echo "| Variable | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |"  >> $GITHUB_STEP_SUMMARY
          echo "| branch name | ${{ needs.setup.branch_name }} |"  >> $GITHUB_STEP_SUMMARY
          echo "| terraform workspace | ${{ needs.setup.terraform_workspace }} |"  >> $GITHUB_STEP_SUMMARY
          echo "| terraform account version | ${{ needs.setup.terraform_version_account }} |"  >> $GITHUB_STEP_SUMMARY
          echo "| terraform environment version | ${{ needs.setup.terraform_version_environment }} |"  >> $GITHUB_STEP_SUMMARY


  end:
    name: 'End of workflow'
    runs-on: 'ubuntu-latest'
    needs: [go_tests, terraform_account, terraform_environment]
    steps:
      - id: end
        name: End
        run: |
          echo "End"
